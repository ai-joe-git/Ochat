<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ochat - Enhanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0066FF;
            --primary-hover: #0052CC;
            --primary-light: #E5F0FF;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F7F8;
            --bg-tertiary: #ECECF1;
            --text-primary: #0D0D0D;
            --text-secondary: #676767;
            --border: #E5E5E5;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2B7FFF;
                --primary-hover: #0066FF;
                --primary-light: #1A2435;
                --bg-primary: #0D0D0D;
                --bg-secondary: #171717;
                --bg-tertiary: #212121;
                --text-primary: #ECECF1;
                --text-secondary: #A0A0A0;
                --border: #2D2D2D;
            }
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 85%;
            max-width: 260px;
            height: 100%;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            z-index: 99;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .search-container {
            padding: 8px 0;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 12px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 14px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .new-chat-btn:active {
            background: var(--primary-hover);
            transform: scale(0.98);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .history-item {
            padding: 8px 10px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: var(--bg-secondary);
        }

        .history-item-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 4px 8px;
            flex-shrink: 0;
        }

        .history-item:hover .delete-btn {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-btn {
            width: 100%;
            padding: 8px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .sidebar-btn:hover {
            background: var(--bg-secondary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 0;
        }

        .chat-header {
            padding: 10px 12px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .toggle-sidebar {
            min-width: 36px;
            min-height: 36px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .model-selector {
            flex: 1;
            min-width: 0;
            padding: 7px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 11px;
        }

        .status-indicator {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .status-indicator.online {
            background: var(--success);
        }

        .status-indicator.offline {
            background: var(--error);
        }

        .status-indicator.retrying {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            min-height: 0;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 16px;
            color: var(--text-secondary);
        }

        .welcome-screen h1 {
            font-size: clamp(20px, 4vw, 28px);
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
        }

        .message.assistant {
            background: var(--bg-primary);
            margin-left: 0;
            margin-right: 0;
            max-width: none;
            padding: 16px 12px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .message-avatar {
            min-width: 28px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 12px;
            background: var(--primary);
            color: white;
        }

        .assistant .message-avatar {
            background: var(--text-secondary);
        }

        .message-content {
            flex: 1;
            line-height: 1.5;
            min-width: 0;
            word-wrap: break-word;
            font-size: 14px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-content code {
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .message-content p code {
            background: var(--bg-tertiary);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px 6px 0 0;
            margin-bottom: -10px;
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .code-lang {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-actions {
            display: flex;
            gap: 4px;
        }

        .code-btn {
            padding: 4px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .preview-container {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        .attached-files {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .file-chip {
            background: var(--bg-secondary);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
        }

        .file-preview-img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        .message-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .action-btn {
            padding: 4px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
        }

        .tts-btn {
            background: var(--success);
            border: 1px solid var(--success);
            color: white;
        }

        .tts-btn:hover {
            opacity: 0.9;
        }

        .tts-btn.playing {
            background: var(--error);
            border-color: var(--error);
        }

        .input-area {
            padding: 12px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .input-container {
            max-width: 48rem;
            margin: 0 auto;
        }

        .input-features {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .feature-btn {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .feature-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .input-wrapper {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        #messageInput {
            width: 100%;
            padding: 10px 44px 10px 10px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 44px;
            max-height: 160px;
            font-family: inherit;
            line-height: 1.4;
        }

        #sendBtn {
            position: absolute;
            right: 6px;
            bottom: 6px;
            min-width: 32px;
            min-height: 32px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #sendBtn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 10px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-modal {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 22px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 16px;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .setting-group input,
        .setting-group select {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .setting-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .save-settings-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .loading {
            display: flex;
            gap: 3px;
            padding: 6px 0;
        }

        .loading span {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }

        .typing-indicator {
            display: flex;
            gap: 3px;
            padding: 10px 0;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .stats-container {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
        }

        .model-manager {
            margin-top: 16px;
        }

        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            background: var(--bg-secondary);
        }

        .model-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .model-item:last-child {
            border-bottom: none;
        }

        .model-actions {
            display: flex;
            gap: 6px;
        }

        .scroll-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 50;
        }

        .auto-scroll-toggle {
            position: absolute;
            right: 50px;
            bottom: 6px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .auto-scroll-toggle.active {
            color: var(--primary);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
            display: block;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            display: none;
        }

        @media (min-width: 768px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
                width: 240px;
                max-width: none;
            }

            .sidebar-overlay {
                display: none;
            }

            .toggle-sidebar {
                display: none;
            }

            .chat-messages {
                padding: 20px;
            }

            .message.assistant {
                padding: 20px;
            }

            .input-features {
                justify-content: flex-start;
            }
        }

        @media (max-width: 767px) {
            .input-features {
                justify-content: center;
            }
            
            .feature-btn {
                flex: 1;
                min-width: 0;
                justify-content: center;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
        }

        @media (max-width: 480px) {
            .message {
                gap: 8px;
            }
            
            .message-avatar {
                min-width: 24px;
                width: 24px;
                height: 24px;
                font-size: 10px;
            }
            
            .input-features {
                justify-content: space-between;
            }
            
            .feature-btn {
                flex: none;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="newChat()">
                    <span>+</span> New Chat
                </button>
                <div class="search-container">
                    <input type="text" id="chatSearch" class="search-input" placeholder="Search chats..." oninput="filterChats(this.value)">
                </div>
            </div>
            <div class="chat-history" id="chatHistory"></div>
            <div class="sidebar-footer">
                <button class="sidebar-btn" onclick="exportChat()">
                    <span>üì§</span> Export Chat
                </button>
                <button class="sidebar-btn" onclick="showStats()">
                    <span>üìä</span> Statistics
                </button>
                <button class="sidebar-btn" onclick="showKeyboardShortcuts()">
                    <span>‚å®Ô∏è</span> Shortcuts
                </button>
                <button class="sidebar-btn" onclick="openSettings()">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="header-left">
                    <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
                    <select class="model-selector" id="modelSelect">
                        <option value="">Select model...</option>
                    </select>
                </div>
                <div class="status-badge" id="statusIndicator">
                    <span class="status-indicator offline"></span>
                    <span id="statusText">Offline</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-screen">
                    <h1>Ochat - Enhanced</h1>
                    <p>How can I help you today?</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-features">
                        <button class="feature-btn" onclick="toggleWebSearch()" id="webSearchBtn">
                            <span>üîç</span> Search
                        </button>
                        <label class="feature-btn" for="fileInput">
                            <span>üìé</span> Attach
                        </label>
                        <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.txt,.md" onchange="handleFileSelect(event)">
                    </div>
                    <div class="attached-files" id="attachedFiles"></div>
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Type a message..."
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <button class="auto-scroll-toggle active" id="autoScrollToggle" onclick="toggleAutoScroll()" title="Auto-scroll">‚Üì</button>
                        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="scroll-indicator" id="scrollToBottom" onclick="scrollToBottom()" title="Scroll to bottom">‚Üì</button>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Ollama Host URL</label>
                    <input type="text" id="ollamaHost" value="http://localhost:11434">
                    <small>The URL where Ollama is running</small>
                </div>
                <div class="setting-group">
                    <label>Search Provider</label>
                    <select id="searchProvider">
                        <option value="duckduckgo">DuckDuckGo (Free)</option>
                        <option value="wikipedia">Wikipedia (Free)</option>
                        <option value="brave">Brave Search (API Key)</option>
                    </select>
                </div>
                <div class="setting-group hidden" id="apiKeyGroup">
                    <label>API Key</label>
                    <input type="password" id="searchApiKey">
                </div>
                <div class="setting-group">
                    <label>Temperature</label>
                    <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1">
                </div>
                <div class="setting-group">
                    <label>Context Length</label>
                    <input type="number" id="contextLength" value="4096" min="512" max="32768" step="512">
                </div>
                <div class="setting-group">
                    <label>Text-to-Speech Voice</label>
                    <select id="voiceSelect">
                        <option value="">Default Voice</option>
                    </select>
                    <small>Choose TTS voice for reading messages</small>
                </div>
                <div class="setting-group">
                    <label>Speech Language</label>
                    <select id="languageSelect">
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish (Spain)</option>
                        <option value="es-MX">Spanish (Mexico)</option>
                        <option value="fr-FR">French (France)</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese (Brazil)</option>
                        <option value="pt-PT">Portuguese (Portugal)</option>
                        <option value="ru-RU">Russian</option>
                        <option value="ja-JP">Japanese</option>
                        <option value="ko-KR">Korean</option>
                        <option value="zh-CN">Chinese (Simplified)</option>
                        <option value="zh-TW">Chinese (Traditional)</option>
                        <option value="ar-SA">Arabic</option>
                        <option value="hi-IN">Hindi</option>
                    </select>
                    <small>Select language for text-to-speech</small>
                </div>
                <div class="setting-group">
                    <label>Speech Rate: <span id="rateValue">1.0x</span></label>
                    <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1" oninput="document.getElementById('rateValue').textContent = this.value + 'x'">
                    <small>Speech speed (0.5x - 2x)</small>
                </div>
                
                <!-- Model Manager -->
                <div class="model-manager">
                    <div class="setting-group">
                        <label>Model Management</label>
                        <button class="feature-btn" onclick="showModelManager()" style="width: 100%">
                            <span>üîÑ</span> Manage Models
                        </button>
                        <small>Pull, delete, or view model information</small>
                    </div>
                    <div id="modelManager" class="hidden">
                        <div class="model-list" id="modelList"></div>
                        <div class="input-features" style="margin-top: 8px">
                            <input type="text" id="newModelName" placeholder="Model name (e.g., llama2)" style="flex: 1">
                            <button class="feature-btn" onclick="pullModel()">Pull Model</button>
                        </div>
                    </div>
                </div>

                <button class="save-settings-btn" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chat Statistics</h2>
                <button class="close-modal" onclick="closeStats()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="stats-container" id="statsContent">
                    <!-- Stats will be populated here -->
                </div>
                <button class="save-settings-btn" onclick="closeStats()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let ollamaHost = localStorage.getItem('ollamaHost') || 'http://localhost:11434';
        let currentModel = localStorage.getItem('currentModel') || '';
        let currentChatId = null;
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        let chatHistory = [];
        let attachedFiles = [];
        let webSearchEnabled = false;
        let isGenerating = false;
        let searchProvider = localStorage.getItem('searchProvider') || 'duckduckgo';
        let searchApiKey = localStorage.getItem('searchApiKey') || '';
        let autoScroll = true;
        let connectionRetries = 0;
        const MAX_RETRIES = 3;

        // TTS variables
        let speechRate = parseFloat(localStorage.getItem('speechRate')) || 1.0;
        let selectedVoice = localStorage.getItem('selectedVoice') || '';
        let selectedLanguage = localStorage.getItem('selectedLanguage') || 'en-US';
        let synthesis = window.speechSynthesis;
        let currentUtterance = null;
        let availableVoices = [];

        // Rate limiting
        let lastMessageTime = 0;
        const MESSAGE_DELAY = 1000; // 1 second between messages

        // Debouncing
        let resizeTimeout;

        let settings = {
            temperature: parseFloat(localStorage.getItem('temperature')) || 0.7,
            contextLength: parseInt(localStorage.getItem('contextLength')) || 4096
        };

        // Enhanced input sanitization
        function sanitizeInput(text) {
            const div = document.createElement('div');
            div.textContent = text;
            // Remove any remaining HTML tags
            return div.innerHTML.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        // Enhanced error handling
        async function handleApiError(error) {
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showError('Network error: Cannot connect to Ollama. Check if it\'s running.');
            } else if (error.message.includes('404')) {
                showError('Model not found. Please check the model name.');
            } else if (error.message.includes('429')) {
                showError('Rate limit exceeded. Please wait a moment.');
            } else {
                showError(`Error: ${error.message}`);
            }
        }

        // File validation
        function validateFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/', 'video/', 'audio/', 'text/', 'application/pdf'];
            
            if (file.size > maxSize) {
                throw new Error('File size too large (max 10MB)');
            }
            
            if (!allowedTypes.some(type => file.type.startsWith(type))) {
                throw new Error('File type not supported');
            }
            
            return true;
        }

        // Load available voices
        function loadVoices() {
            availableVoices = synthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Default Voice</option>';

            // Filter voices by selected language
            const filteredVoices = availableVoices.filter(v => v.lang.startsWith(selectedLanguage.split('-')[0]));
            const voicesToShow = filteredVoices.length > 0 ? filteredVoices : availableVoices;

            voicesToShow.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = voice.name;
                option.textContent = `${voice.name} (${voice.lang})`;
                if (voice.default) option.textContent += ' - Default';
                voiceSelect.appendChild(option);
            });

            if (selectedVoice) {
                voiceSelect.value = selectedVoice;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            checkOllamaStatusWithRetry();
            loadModels();
            loadChatHistory();
            loadVoices();
            setupEventListeners();
            setupScrollDetection();
            restoreSessionState();

            if (synthesis.onvoiceschanged !== undefined) {
                synthesis.onvoiceschanged = loadVoices;
            }

            document.getElementById('speechRate').value = speechRate;
            document.getElementById('rateValue').textContent = speechRate + 'x';
            document.getElementById('languageSelect').value = selectedLanguage;

            // Auto-save every 30 seconds
            setInterval(() => {
                if (chatHistory.length > 0) {
                    saveCurrentChat();
                }
            }, 30000);
        });

        function setupEventListeners() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 160) + 'px';
                }, 100);
            });

            document.getElementById('searchProvider').addEventListener('change', function() {
                document.getElementById('apiKeyGroup').classList.toggle('hidden', this.value !== 'brave');
            });

            document.getElementById('languageSelect').addEventListener('change', function() {
                selectedLanguage = this.value;
                loadVoices();
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    newChat();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    toggleSidebar();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportChat();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }
            });

            // Auto-scroll toggle
            document.getElementById('autoScrollToggle').addEventListener('click', toggleAutoScroll);

            // Save before unload
            window.addEventListener('beforeunload', () => {
                if (chatHistory.length > 0) {
                    saveCurrentChat();
                    saveSessionState();
                }
            });
        }

        // Session management
        function saveSessionState() {
            const session = {
                currentChatId,
                scrollPosition: document.getElementById('chatMessages').scrollTop,
                attachedFiles,
                webSearchEnabled
            };
            sessionStorage.setItem('currentSession', JSON.stringify(session));
        }

        function restoreSessionState() {
            const session = JSON.parse(sessionStorage.getItem('currentSession'));
            if (session) {
                currentChatId = session.currentChatId;
                attachedFiles = session.attachedFiles || [];
                webSearchEnabled = session.webSearchEnabled || false;
                
                if (session.scrollPosition) {
                    setTimeout(() => {
                        document.getElementById('chatMessages').scrollTop = session.scrollPosition;
                    }, 100);
                }
                
                if (webSearchEnabled) {
                    document.getElementById('webSearchBtn').classList.add('active');
                }
                
                displayAttachedFiles();
            }
        }

        function setupScrollDetection() {
            const messagesDiv = document.getElementById('chatMessages');
            const scrollIndicator = document.getElementById('scrollToBottom');
            
            messagesDiv.addEventListener('scroll', () => {
                const isAtBottom = messagesDiv.scrollHeight - messagesDiv.clientHeight <= messagesDiv.scrollTop + 50;
                
                if (isAtBottom) {
                    scrollIndicator.style.display = 'none';
                } else {
                    scrollIndicator.style.display = 'flex';
                }
                
                // Save scroll position for session restoration
                saveSessionState();
            });
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const toggleBtn = document.getElementById('autoScrollToggle');
            toggleBtn.classList.toggle('active', autoScroll);
            toggleBtn.title = autoScroll ? 'Auto-scroll: ON' : 'Auto-scroll: OFF';
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTo({
                top: messagesDiv.scrollHeight,
                behavior: 'smooth'
            });
        }

        function speakText(text, button) {
            if (!text || text.trim().length === 0) return;

            // If currently speaking this text, stop it
            if (currentUtterance && button) {
                stopSpeaking();
                button.textContent = '‚ñ∂Ô∏è TTS';
                button.classList.remove('playing');
                return;
            }

            stopSpeaking();

            // Clean text for TTS
            const cleanText = text
                .replace(/[#*`_]/g, '')
                .replace(/\n/g, ' ')
                .replace(/\[.*?\]/g, '')
                .replace(/\(.*?\)/g, '')
                .replace(/<[^>]*>/g, '')
                .trim();

            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            currentUtterance.rate = speechRate;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;
            currentUtterance.lang = selectedLanguage;

            // Set voice if selected
            if (selectedVoice) {
                const voice = availableVoices.find(v => v.name === selectedVoice);
                if (voice) {
                    currentUtterance.voice = voice;
                }
            }

            currentUtterance.onstart = () => {
                if (button) {
                    button.textContent = '‚è∏Ô∏è TTS';
                    button.classList.add('playing');
                }
            };

            currentUtterance.onend = () => {
                if (button) {
                    button.textContent = '‚ñ∂Ô∏è TTS';
                    button.classList.remove('playing');
                }
                currentUtterance = null;
            };

            currentUtterance.onerror = (event) => {
                console.error('Speech synthesis error:', event);
                if (button) {
                    button.textContent = '‚ñ∂Ô∏è TTS';
                    button.classList.remove('playing');
                }
                currentUtterance = null;
            };

            synthesis.speak(currentUtterance);
        }

        function stopSpeaking() {
            if (synthesis.speaking) {
                synthesis.cancel();
                currentUtterance = null;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        async function checkOllamaStatusWithRetry() {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    indicator.className = 'status-indicator retrying';
                    statusText.textContent = `Connecting... (${i + 1}/${MAX_RETRIES})`;
                    
                    const response = await fetch(`${ollamaHost}/api/tags`);
                    if (response.ok) {
                        updateStatus(true);
                        connectionRetries = 0;
                        return;
                    }
                } catch (error) {
                    console.log(`Connection attempt ${i + 1} failed`);
                }
                
                if (i < MAX_RETRIES - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            updateStatus(false);
        }

        function updateStatus(isOnline) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            indicator.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
            statusText.textContent = isOnline ? 'Online' : 'Offline';
        }

        async function loadModels() {
            try {
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '<option value="">Loading models...</option>';
                
                const response = await fetch(`${ollamaHost}/api/tags`);
                if (!response.ok) throw new Error('Failed to fetch models');
                
                const data = await response.json();
                modelSelect.innerHTML = '<option value="">Select model...</option>';

                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                if (currentModel && data.models.find(m => m.name === currentModel)) {
                    modelSelect.value = currentModel;
                } else if (data.models.length > 0) {
                    currentModel = data.models[0].name;
                    modelSelect.value = currentModel;
                    localStorage.setItem('currentModel', currentModel);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                modelSelect.innerHTML = '<option value="">Failed to load models</option>';
                showError('Failed to load models. Check if Ollama is running.');
            }
        }

        document.getElementById('modelSelect').addEventListener('change', (e) => {
            currentModel = e.target.value;
            localStorage.setItem('currentModel', currentModel);
        });

        function filterChats(query) {
            const historyItems = document.querySelectorAll('.history-item');
            const lowercaseQuery = query.toLowerCase();
            
            historyItems.forEach(item => {
                const text = item.querySelector('.history-item-text').textContent.toLowerCase();
                if (text.includes(lowercaseQuery)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function loadChatHistory() {
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';

            // Sort chats by timestamp (newest first)
            chats.sort((a, b) => b.timestamp - a.timestamp);

            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';

                const textSpan = document.createElement('span');
                textSpan.className = 'history-item-text';
                textSpan.textContent = chat.title;

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(chat.id);
                };

                item.appendChild(textSpan);
                item.appendChild(deleteBtn);

                item.onclick = () => loadChat(chat.id);
                historyDiv.appendChild(item);
            });
        }

        function saveCurrentChat() {
            if (chatHistory.length === 0) return;

            const chatIndex = chats.findIndex(c => c.id === currentChatId);
            const title = chatHistory[0].content.substring(0, 50) || 'New Chat';

            const chatData = {
                id: currentChatId,
                title: title,
                messages: chatHistory,
                timestamp: Date.now()
            };

            if (chatIndex >= 0) {
                chats[chatIndex] = chatData;
            } else {
                chats.unshift(chatData);
            }

            // Keep only last 50 chats to prevent storage issues
            if (chats.length > 50) {
                chats = chats.slice(0, 50);
            }

            localStorage.setItem('chats', JSON.stringify(chats));
            loadChatHistory();
        }

        function loadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            chatHistory = chat.messages;

            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            chatHistory.forEach(msg => {
                if (msg.role === 'user' || msg.role === 'assistant') {
                    addMessageToChat(msg.role, msg.content, [], false);
                }
            });

            closeSidebar();
            if (autoScroll) {
                scrollToBottom();
            }
            
            saveSessionState();
        }

        function deleteChat(chatId) {
            if (!confirm('Are you sure you want to delete this chat?')) return;
            
            chats = chats.filter(c => c.id !== chatId);
            localStorage.setItem('chats', JSON.stringify(chats));
            if (currentChatId === chatId) {
                newChat();
            }
            loadChatHistory();
        }

        function newChat() {
            if (chatHistory.length > 0) {
                saveCurrentChat();
            }
            
            currentChatId = 'chat_' + Date.now();
            chatHistory = [];
            attachedFiles = [];
            stopSpeaking();
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-screen">
                    <h1>Ochat - Enhanced</h1>
                    <p>How can I help you today?</p>
                </div>
            `;
            closeSidebar();
            saveSessionState();
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                try {
                    validateFile(file);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        attachedFiles.push({
                            name: file.name,
                            type: file.type,
                            data: e.target.result
                        });
                        displayAttachedFiles();
                        saveSessionState();
                    };

                    if (file.type.startsWith('image/')) {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                } catch (error) {
                    showError(error.message);
                }
            });
            event.target.value = '';
        }

        function displayAttachedFiles() {
            const container = document.getElementById('attachedFiles');
            container.innerHTML = '';
            attachedFiles.forEach((file, index) => {
                const chip = document.createElement('div');
                chip.className = 'file-chip';
                chip.innerHTML = `
                    <span>${getFileIcon(file.type)} ${file.name}</span>
                    <button onclick="removeFile(${index})">√ó</button>
                `;
                container.appendChild(chip);
            });
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            displayAttachedFiles();
            saveSessionState();
        }

        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.startsWith('video/')) return 'üé•';
            if (type.startsWith('audio/')) return 'üéµ';
            return 'üìÑ';
        }

        function toggleWebSearch() {
            webSearchEnabled = !webSearchEnabled;
            document.getElementById('webSearchBtn').classList.toggle('active');
            saveSessionState();
        }

        async function performWebSearch(query) {
            try {
                if (searchProvider === 'duckduckgo') {
                    const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`;
                    const response = await fetch(url);
                    const data = await response.json();

                    let results = '\n\nüîç Search Results:\n\n';
                    if (data.Abstract) results += data.Abstract + '\n';
                    if (data.RelatedTopics) {
                        data.RelatedTopics.slice(0, 5).forEach(topic => {
                            if (topic.Text) results += '‚Ä¢ ' + topic.Text + '\n';
                        });
                    }
                    return results || 'No results found.';

                } else if (searchProvider === 'wikipedia') {
                    const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`;
                    const response = await fetch(url);
                    const data = await response.json();

                    let results = '\n\nüîç Search Results:\n\n';
                    data.query.search.forEach(result => {
                        results += `**${result.title}**\n${result.snippet.replace(/<[^>]*>/g, '')}\n\n`;
                    });
                    return results;

                } else if (searchProvider === 'brave' && searchApiKey) {
                    const response = await fetch(`https://api.search.brave.com/res/v1/web/search?q=${encodeURIComponent(query)}`, {
                        headers: { 'X-Subscription-Token': searchApiKey }
                    });
                    const data = await response.json();
                    let results = '\n\nüîç Search Results:\n\n';
                    data.web?.results.slice(0, 5).forEach(r => {
                        results += `**${r.title}**\n${r.description}\n${r.url}\n\n`;
                    });
                    return results;
                }
            } catch (error) {
                console.error('Search error:', error);
                return '\n\nSearch unavailable.';
            }
        }

        async function sendMessage() {
            // Rate limiting
            const now = Date.now();
            if (now - lastMessageTime < MESSAGE_DELAY) {
                showError('Please wait a moment before sending another message');
                return;
            }
            lastMessageTime = now;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !currentModel || isGenerating) return;

            // Input sanitization
            const sanitizedMessage = sanitizeInput(message);
            if (!sanitizedMessage.trim()) return;

            isGenerating = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            closeSidebar();

            addMessageToChat('user', sanitizedMessage, attachedFiles);
            input.value = '';
            input.style.height = 'auto';

            const messages = chatHistory.map(msg => ({
                role: msg.role,
                content: msg.content,
                ...(msg.images && { images: msg.images })
            }));

            const assistantDiv = addMessageToChat('assistant', '', [], true);
            const contentDiv = assistantDiv.querySelector('.message-content');
            
            // Add typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            contentDiv.appendChild(typingIndicator);

            try {
                if (webSearchEnabled) {
                    contentDiv.innerHTML = 'üîç Searching...';
                    const searchResults = await performWebSearch(message);
                    messages[messages.length - 1].content += searchResults;
                }

                const response = await fetch(`${ollamaHost}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: messages,
                        stream: true,
                        options: {
                            temperature: settings.temperature,
                            num_ctx: settings.contextLength
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                contentDiv.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        try {
                            const json = JSON.parse(line);
                            if (json.message?.content) {
                                fullResponse += json.message.content;
                                contentDiv.innerHTML = renderMarkdown(fullResponse);
                                highlightCode(contentDiv);
                                
                                if (autoScroll) {
                                    scrollToBottom();
                                }
                            }
                        } catch (e) {
                            // Ignore JSON parse errors for incomplete chunks
                        }
                    }
                }

                // Add TTS button after response is complete
                const ttsBtn = document.createElement('button');
                ttsBtn.className = 'tts-btn action-btn';
                ttsBtn.textContent = '‚ñ∂Ô∏è TTS';
                ttsBtn.onclick = () => speakText(fullResponse, ttsBtn);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'action-btn';
                copyBtn.textContent = 'üìã Copy';
                copyBtn.onclick = () => copyToClipboard(fullResponse);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.appendChild(ttsBtn);
                actionsDiv.appendChild(copyBtn);
                
                contentDiv.insertBefore(actionsDiv, contentDiv.firstChild);

                chatHistory.push({ role: 'assistant', content: fullResponse });
                saveCurrentChat();

            } catch (error) {
                console.error('Send message error:', error);
                await handleApiError(error);
                contentDiv.innerHTML = `<p style="color: var(--error);">Error: ${error.message}. Check if Ollama is running and model is loaded.</p>`;
            } finally {
                attachedFiles = [];
                displayAttachedFiles();
                isGenerating = false;
                sendBtn.disabled = false;
                saveSessionState();
            }
        }

        function addMessageToChat(role, content, files = [], saveToHistory = true) {
            const messagesDiv = document.getElementById('chatMessages');
            const welcome = messagesDiv.querySelector('.welcome-screen');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'user') {
                contentDiv.innerHTML = renderMarkdown(content);

                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = file.data;
                        img.className = 'file-preview-img';
                        contentDiv.appendChild(img);
                    }
                });

                if (saveToHistory) {
                    const images = files.filter(f => f.type.startsWith('image/')).map(f => f.data.split(',')[1]);
                    chatHistory.push({
                        role: 'user',
                        content: content,
                        ...(images.length > 0 && { images: images })
                    });
                }
            } else if (role === 'assistant') {
                if (content) {
                    contentDiv.innerHTML = renderMarkdown(content);
                    highlightCode(contentDiv);
                }
                
                if (saveToHistory && content) {
                    chatHistory.push({ role: 'assistant', content: content });
                }
            }

            // Add timestamp
            const timestamp = new Date().toLocaleTimeString();
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = timestamp;
            contentDiv.appendChild(timeSpan);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);

            if (autoScroll) {
                scrollToBottom();
            }

            return messageDiv;
        }

        function renderMarkdown(text) {
            marked.setOptions({
                highlight: (code, lang) => {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });

            let html = marked.parse(text);

            // Only add preview button to code blocks with language-html class
            html = html.replace(/<pre><code class="language-html">(.*?)<\/code><\/pre>/gs, (match, code) => {
                return `
                    <div class="code-header">
                        <span class="code-lang">html</span>
                        <div class="code-actions">
                            <button class="code-btn" onclick="copyCode(this)">Copy</button>
                            <button class="code-btn" onclick="previewHtml(this)">Preview</button>
                        </div>
                    </div>
                    <pre><code class="language-html">${code}</code></pre>
                `;
            });

            // Add copy button for other code blocks
            html = html.replace(/<pre><code class="language-(\w+)">(.*?)<\/code><\/pre>/gs, (match, lang, code) => {
                if (lang === 'html') return match; // Already handled above
                return `
                    <div class="code-header">
                        <span class="code-lang">${lang}</span>
                        <div class="code-actions">
                            <button class="code-btn" onclick="copyCode(this)">Copy</button>
                        </div>
                    </div>
                    <pre><code class="language-${lang}">${code}</code></pre>
                `;
            });

            return html;
        }

        function highlightCode(container) {
            container.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        }

        function copyCode(btn) {
            const code = btn.closest('.code-header').nextElementSibling.querySelector('code').textContent;
            copyToClipboard(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showTemporaryMessage('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function previewHtml(btn) {
            const codeElement = btn.closest('.code-header').nextElementSibling.querySelector('code');
            const html = codeElement.textContent;
            const existing = btn.closest('.message-content').querySelector('.preview-container');

            if (existing) {
                existing.remove();
                btn.textContent = 'Preview';
                return;
            }

            const preview = document.createElement('div');
            preview.className = 'preview-container';

            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.minHeight = '300px';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '6px';
            iframe.style.backgroundColor = 'white';

            preview.appendChild(iframe);
            btn.closest('.code-header').nextElementSibling.after(preview);

            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();

            setTimeout(() => {
                try {
                    const body = iframe.contentDocument.body;
                    const html = iframe.contentDocument.documentElement;
                    const height = Math.max(
                        body.scrollHeight,
                        body.offsetHeight,
                        html.clientHeight,
                        html.scrollHeight,
                        html.offsetHeight
                    );
                    iframe.style.height = (height + 20) + 'px';
                } catch (e) {
                    iframe.style.height = '400px';
                }
            }, 100);

            btn.textContent = 'Hide';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function loadSettings() {
            document.getElementById('ollamaHost').value = ollamaHost;
            document.getElementById('searchProvider').value = searchProvider;
            document.getElementById('searchApiKey').value = searchApiKey;
            document.getElementById('temperature').value = settings.temperature;
            document.getElementById('contextLength').value = settings.contextLength;
            document.getElementById('voiceSelect').value = selectedVoice;
            document.getElementById('languageSelect').value = selectedLanguage;
            document.getElementById('speechRate').value = speechRate;
            document.getElementById('rateValue').textContent = speechRate + 'x';
            document.getElementById('apiKeyGroup').classList.toggle('hidden', searchProvider !== 'brave');
        }

        function saveSettings() {
            ollamaHost = document.getElementById('ollamaHost').value;
            searchProvider = document.getElementById('searchProvider').value;
            searchApiKey = document.getElementById('searchApiKey').value;
            settings.temperature = parseFloat(document.getElementById('temperature').value);
            settings.contextLength = parseInt(document.getElementById('contextLength').value);
            selectedVoice = document.getElementById('voiceSelect').value;
            selectedLanguage = document.getElementById('languageSelect').value;
            speechRate = parseFloat(document.getElementById('speechRate').value);

            localStorage.setItem('ollamaHost', ollamaHost);
            localStorage.setItem('searchProvider', searchProvider);
            localStorage.setItem('searchApiKey', searchApiKey);
            localStorage.setItem('temperature', settings.temperature);
            localStorage.setItem('contextLength', settings.contextLength);
            localStorage.setItem('selectedVoice', selectedVoice);
            localStorage.setItem('selectedLanguage', selectedLanguage);
            localStorage.setItem('speechRate', speechRate);

            closeSettings();
            checkOllamaStatusWithRetry();
            loadModels();
            loadVoices();
            showTemporaryMessage('Settings saved!');
        }

        // Model Management
        async function showModelManager() {
            const manager = document.getElementById('modelManager');
            const modelList = document.getElementById('modelList');
            
            manager.classList.toggle('hidden');
            
            if (!manager.classList.contains('hidden')) {
                try {
                    const response = await fetch(`${ollamaHost}/api/tags`);
                    const data = await response.json();
                    
                    modelList.innerHTML = '';
                    data.models.forEach(model => {
                        const item = document.createElement('div');
                        item.className = 'model-item';
                        item.innerHTML = `
                            <span>${model.name}</span>
                            <div class="model-actions">
                                <button class="action-btn" onclick="deleteModel('${model.name}')">Delete</button>
                                <button class="action-btn" onclick="showModelInfo('${model.name}')">Info</button>
                            </div>
                        `;
                        modelList.appendChild(item);
                    });
                } catch (error) {
                    showError('Failed to load models');
                }
            }
        }

        async function pullModel() {
            const modelName = document.getElementById('newModelName').value.trim();
            if (!modelName) {
                showError('Please enter a model name');
                return;
            }

            try {
                showTemporaryMessage(`Pulling model: ${modelName}...`);
                const response = await fetch(`${ollamaHost}/api/pull`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                if (!response.ok) throw new Error('Failed to pull model');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());
                    
                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            if (data.status === 'success') {
                                showTemporaryMessage(`Model ${modelName} pulled successfully!`);
                                loadModels();
                                showModelManager(); // Refresh model list
                            }
                        } catch (e) {}
                    }
                }
            } catch (error) {
                showError(`Failed to pull model: ${error.message}`);
            }
        }

        async function deleteModel(modelName) {
            if (!confirm(`Are you sure you want to delete ${modelName}?`)) return;
            
            try {
                const response = await fetch(`${ollamaHost}/api/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });

                if (response.ok) {
                    showTemporaryMessage(`Model ${modelName} deleted`);
                    loadModels();
                    showModelManager(); // Refresh model list
                } else {
                    throw new Error('Delete failed');
                }
            } catch (error) {
                showError(`Failed to delete model: ${error.message}`);
            }
        }

        async function showModelInfo(modelName) {
            try {
                const response = await fetch(`${ollamaHost}/api/show`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: modelName })
                });
                
                const data = await response.json();
                alert(`Model: ${modelName}\nParameters: ${data.parameters || 'N/A'}\nSize: ${formatBytes(data.size || 0)}`);
            } catch (error) {
                showError('Failed to get model info');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Statistics
        function showStats() {
            const stats = {
                totalChats: chats.length,
                totalMessages: chatHistory.length,
                userMessages: chatHistory.filter(m => m.role === 'user').length,
                assistantMessages: chatHistory.filter(m => m.role === 'assistant').length,
                currentModel: currentModel || 'None selected'
            };

            const statsContent = document.getElementById('statsContent');
            statsContent.innerHTML = `
                <div class="stats-item">
                    <span>Total Chats:</span>
                    <span>${stats.totalChats}</span>
                </div>
                <div class="stats-item">
                    <span>Total Messages:</span>
                    <span>${stats.totalMessages}</span>
                </div>
                <div class="stats-item">
                    <span>Your Messages:</span>
                    <span>${stats.userMessages}</span>
                </div>
                <div class="stats-item">
                    <span>AI Responses:</span>
                    <span>${stats.assistantMessages}</span>
                </div>
                <div class="stats-item">
                    <span>Current Model:</span>
                    <span>${stats.currentModel}</span>
                </div>
            `;

            document.getElementById('statsModal').classList.add('active');
            closeSidebar();
        }

        function closeStats() {
            document.getElementById('statsModal').classList.remove('active');
        }

        // Keyboard shortcuts helper
        function showKeyboardShortcuts() {
            const shortcuts = `
Ctrl+K: New Chat
Ctrl+/: Toggle Sidebar
Ctrl+E: Export Chat
Ctrl+H: Show Shortcuts
Enter: Send Message
Shift+Enter: New Line
            `;
            alert('Keyboard Shortcuts:\n' + shortcuts);
        }

        // Export functionality
        function exportChat() {
            if (chatHistory.length === 0) {
                showError('No chat to export');
                return;
            }

            const chatData = {
                title: `Ochat Export - ${new Date().toLocaleDateString()}`,
                model: currentModel,
                messages: chatHistory,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(chatData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ochat-export-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showTemporaryMessage('Chat exported successfully!');
            closeSidebar();
        }

        // Utility functions
        function showError(message) {
            showTemporaryMessage(message, 'error');
        }

        function showTemporaryMessage(message, type = 'success') {
            const existingMsg = document.querySelector('.temp-message');
            if (existingMsg) existingMsg.remove();

            const msg = document.createElement('div');
            msg.className = `temp-message`;
            msg.textContent = message;
            msg.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--error)' : 'var(--success)'};
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: var(--shadow-lg);
            `;

            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') closeSettings();
        });

        document.getElementById('statsModal').addEventListener('click', (e) => {
            if (e.target.id === 'statsModal') closeStats();
        });
    </script>
</body>
</html>