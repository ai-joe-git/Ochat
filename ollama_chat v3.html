<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ollama Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0066FF;
            --primary-hover: #0052CC;
            --primary-light: #E5F0FF;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F7F8;
            --bg-tertiary: #ECECF1;
            --text-primary: #0D0D0D;
            --text-secondary: #676767;
            --border: #E5E5E5;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #2B7FFF;
                --primary-hover: #0066FF;
                --primary-light: #1A2435;
                --bg-primary: #232222;
                --bg-secondary: #2c2c2c;
                --bg-tertiary: #212121;
                --text-primary: #ECECF1;
                --text-secondary: #A0A0A0;
                --border: #2D2D2D;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 85%;
            max-width: 260px;
            height: 100vh;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            z-index: 99;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 14px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .new-chat-btn:active {
            background: var(--primary-hover);
            transform: scale(0.98);
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .history-item {
            padding: 8px 10px;
            margin: 3px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
            color: var(--text-primary);
        }

        .history-item:hover {
            background: var(--bg-secondary);
        }

        .history-item:active {
            background: var(--bg-tertiary);
        }

        .history-item .delete-btn {
            float: right;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 12px;
        }

        .history-item:hover .delete-btn {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .settings-btn {
            width: 100%;
            padding: 8px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: var(--bg-secondary);
        }

        .settings-btn:active {
            background: var(--bg-tertiary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .chat-header {
            padding: 10px 12px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .toggle-sidebar {
            min-width: 36px;
            min-height: 36px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .toggle-sidebar:hover {
            background: var(--bg-secondary);
        }

        .toggle-sidebar:active {
            background: var(--bg-tertiary);
        }

        .model-selector {
            flex: 1;
            min-width: 0;
            padding: 7px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 11px;
        }

        .status-indicator {
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .status-indicator.online {
            background: #10B981;
        }

        .status-indicator.offline {
            background: #EF4444;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
        }

        .welcome-screen {
            text-align: center;
            padding: 40px 16px;
            color: var(--text-secondary);
        }

        .welcome-screen h1 {
            font-size: clamp(20px, 4vw, 28px);
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            gap: 10px;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
        }

        .message.assistant {
            background: var(--bg-primary);
            margin-left: 0;
            margin-right: 0;
            max-width: none;
            padding: 16px 12px;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .message-avatar {
            min-width: 28px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 12px;
            background: var(--primary);
            color: white;
        }

        .assistant .message-avatar {
            background: var(--text-secondary);
        }

        .message-content {
            flex: 1;
            line-height: 1.5;
            min-width: 0;
            word-wrap: break-word;
            font-size: 14px;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content pre {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            overflow-x: auto;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .message-content code {
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .message-content p code {
            background: var(--bg-tertiary);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px 6px 0 0;
            margin-bottom: -10px;
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .code-lang {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
        }

        .code-actions {
            display: flex;
            gap: 4px;
        }

        .code-btn {
            padding: 4px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .code-btn:hover {
            background: var(--bg-secondary);
        }

        .code-btn:active {
            transform: scale(0.95);
        }

        .preview-container {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        .attached-files {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .file-chip {
            background: var(--bg-secondary);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
        }

        .file-chip button {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }

        .file-preview-img {
            max-width: 100%;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }

        /* Input Area */
        .input-area {
            padding: 12px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }

        .input-container {
            max-width: 48rem;
            margin: 0 auto;
        }

        .input-features {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .feature-btn {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .feature-btn:hover {
            background: var(--bg-tertiary);
        }

        .feature-btn:active {
            transform: scale(0.98);
        }

        .feature-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .input-wrapper {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        #messageInput {
            width: 100%;
            padding: 10px 44px 10px 10px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 44px;
            max-height: 160px;
            font-family: inherit;
            line-height: 1.4;
        }

        #messageInput::placeholder {
            color: var(--text-secondary);
        }

        #sendBtn {
            position: absolute;
            right: 6px;
            bottom: 6px;
            min-width: 32px;
            min-height: 32px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        #sendBtn:hover {
            background: var(--primary-hover);
        }

        #sendBtn:active {
            transform: scale(0.95);
        }

        #sendBtn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 10px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-modal {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 22px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: var(--bg-secondary);
        }

        .modal-body {
            padding: 16px;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .setting-group input,
        .setting-group select {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .setting-group input:focus,
        .setting-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .setting-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .save-settings-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .save-settings-btn:hover {
            background: var(--primary-hover);
        }

        .save-settings-btn:active {
            transform: scale(0.98);
        }

        .loading {
            display: flex;
            gap: 3px;
            padding: 6px 0;
        }

        .loading span {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            display: none;
        }

        @media (min-width: 768px) {
            .sidebar {
                position: relative;
                transform: translateX(0);
                width: 240px;
                max-width: none;
            }

            .sidebar-overlay {
                display: none;
            }

            .toggle-sidebar {
                display: none;
            }

            .chat-messages {
                padding: 20px;
            }

            .message.assistant {
                padding: 20px;
            }
        }

        @media (min-width: 1024px) {
            .sidebar {
                width: 260px;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="newChat()">
                    <span>+</span> New Chat
                </button>
            </div>
            <div class="chat-history" id="chatHistory"></div>
            <div class="sidebar-footer">
                <button class="settings-btn" onclick="openSettings()">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="header-left">
                    <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
                    <select class="model-selector" id="modelSelect">
                        <option value="">Select model...</option>
                    </select>
                </div>
                <div class="status-badge" id="statusIndicator">
                    <span class="status-indicator offline"></span>
                    <span id="statusText">Offline</span>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="welcome-screen">
                    <h1>Ollama Chat</h1>
                    <p>How can I help you today?</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-features">
                        <button class="feature-btn" onclick="toggleWebSearch()" id="webSearchBtn">
                            <span>üîç</span> Search
                        </button>
                        <label class="feature-btn" for="fileInput">
                            <span>üìé</span> Attach
                        </label>
                        <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*,.pdf,.txt,.md" onchange="handleFileSelect(event)">
                    </div>
                    <div class="attached-files" id="attachedFiles"></div>
                    <div class="input-wrapper">
                        <textarea 
                            id="messageInput" 
                            placeholder="Type a message..."
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" onclick="closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Ollama Host URL</label>
                    <input type="text" id="ollamaHost" value="http://localhost:11434">
                    <small>The URL where Ollama is running</small>
                </div>
                <div class="setting-group">
                    <label>Search Provider</label>
                    <select id="searchProvider">
                        <option value="duckduckgo">DuckDuckGo (Free)</option>
                        <option value="wikipedia">Wikipedia (Free)</option>
                        <option value="brave">Brave Search (API Key)</option>
                    </select>
                </div>
                <div class="setting-group hidden" id="apiKeyGroup">
                    <label>API Key</label>
                    <input type="password" id="searchApiKey">
                </div>
                <div class="setting-group">
                    <label>Temperature</label>
                    <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1">
                </div>
                <div class="setting-group">
                    <label>Context Length</label>
                    <input type="number" id="contextLength" value="4096" min="512" max="32768" step="512">
                </div>
                <button class="save-settings-btn" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let ollamaHost = localStorage.getItem('ollamaHost') || 'http://localhost:11434';
        let currentModel = localStorage.getItem('currentModel') || '';
        let currentChatId = null;
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        let chatHistory = [];
        let attachedFiles = [];
        let webSearchEnabled = false;
        let isGenerating = false;
        let searchProvider = localStorage.getItem('searchProvider') || 'duckduckgo';
        let searchApiKey = localStorage.getItem('searchApiKey') || '';

        let settings = {
            temperature: parseFloat(localStorage.getItem('temperature')) || 0.7,
            contextLength: parseInt(localStorage.getItem('contextLength')) || 4096
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            checkOllamaStatus();
            loadModels();
            loadChatHistory();

            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 160) + 'px';
            });

            document.getElementById('searchProvider').addEventListener('change', function() {
                document.getElementById('apiKeyGroup').classList.toggle('hidden', this.value !== 'brave');
            });
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }

        async function checkOllamaStatus() {
            try {
                const response = await fetch(`${ollamaHost}/api/tags`);
                updateStatus(response.ok);
            } catch {
                updateStatus(false);
            }
        }

        function updateStatus(isOnline) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            indicator.className = `status-indicator ${isOnline ? 'online' : 'offline'}`;
            statusText.textContent = isOnline ? 'Online' : 'Offline';
        }

        async function loadModels() {
            try {
                const response = await fetch(`${ollamaHost}/api/tags`);
                const data = await response.json();
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '<option value="">Select model...</option>';

                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelect.appendChild(option);
                });

                if (currentModel && data.models.find(m => m.name === currentModel)) {
                    modelSelect.value = currentModel;
                } else if (data.models.length > 0) {
                    currentModel = data.models[0].name;
                    modelSelect.value = currentModel;
                    localStorage.setItem('currentModel', currentModel);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        document.getElementById('modelSelect').addEventListener('change', (e) => {
            currentModel = e.target.value;
            localStorage.setItem('currentModel', currentModel);
        });

        // Chat persistence
        function loadChatHistory() {
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML = '';

            chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    ${chat.title}
                    <button class="delete-btn" onclick="deleteChat('${chat.id}', event)">üóëÔ∏è</button>
                `;
                item.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) loadChat(chat.id);
                };
                historyDiv.appendChild(item);
            });
        }

        function saveCurrentChat() {
            if (chatHistory.length === 0) return;

            const chatIndex = chats.findIndex(c => c.id === currentChatId);
            const title = chatHistory[0].content.substring(0, 50) || 'New Chat';

            const chatData = {
                id: currentChatId,
                title: title,
                messages: chatHistory,
                timestamp: Date.now()
            };

            if (chatIndex >= 0) {
                chats[chatIndex] = chatData;
            } else {
                chats.unshift(chatData);
            }

            localStorage.setItem('chats', JSON.stringify(chats));
            loadChatHistory();
        }

        function loadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            chatHistory = chat.messages;

            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            chatHistory.forEach(msg => {
                if (msg.role === 'user' || msg.role === 'assistant') {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role}`;

                    const avatar = document.createElement('div');
                    avatar.className = 'message-avatar';
                    avatar.textContent = msg.role === 'user' ? 'U' : 'AI';

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.innerHTML = renderMarkdown(msg.content);
                    highlightCode(contentDiv);

                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(contentDiv);
                    messagesDiv.appendChild(messageDiv);
                }
            });

            closeSidebar();
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            chats = chats.filter(c => c.id !== chatId);
            localStorage.setItem('chats', JSON.stringify(chats));
            if (currentChatId === chatId) {
                newChat();
            }
            loadChatHistory();
        }

        function newChat() {
            currentChatId = 'chat_' + Date.now();
            chatHistory = [];
            attachedFiles = [];
            document.getElementById('chatMessages').innerHTML = `
                <div class="welcome-screen">
                    <h1>Ollama Chat</h1>
                    <p>How can I help you today?</p>
                </div>
            `;
            closeSidebar();
        }

        // File handling
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedFiles.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result
                    });
                    displayAttachedFiles();
                };

                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });
            event.target.value = '';
        }

        function displayAttachedFiles() {
            const container = document.getElementById('attachedFiles');
            container.innerHTML = '';
            attachedFiles.forEach((file, index) => {
                const chip = document.createElement('div');
                chip.className = 'file-chip';
                chip.innerHTML = `
                    <span>${getFileIcon(file.type)} ${file.name}</span>
                    <button onclick="removeFile(${index})">√ó</button>
                `;
                container.appendChild(chip);
            });
        }

        function removeFile(index) {
            attachedFiles.splice(index, 1);
            displayAttachedFiles();
        }

        function getFileIcon(type) {
            if (type.startsWith('image/')) return 'üñºÔ∏è';
            if (type.startsWith('video/')) return 'üé•';
            if (type.startsWith('audio/')) return 'üéµ';
            return 'üìÑ';
        }

        function toggleWebSearch() {
            webSearchEnabled = !webSearchEnabled;
            document.getElementById('webSearchBtn').classList.toggle('active');
        }

        // Web Search
        async function performWebSearch(query) {
            try {
                if (searchProvider === 'duckduckgo') {
                    const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`;
                    const response = await fetch(url);
                    const data = await response.json();

                    let results = '\n\nüîç Search Results:\n\n';
                    if (data.Abstract) results += data.Abstract + '\n';
                    if (data.RelatedTopics) {
                        data.RelatedTopics.slice(0, 5).forEach(topic => {
                            if (topic.Text) results += '‚Ä¢ ' + topic.Text + '\n';
                        });
                    }
                    return results || 'No results found.';

                } else if (searchProvider === 'wikipedia') {
                    const url = `https://en.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*&srlimit=3`;
                    const response = await fetch(url);
                    const data = await response.json();

                    let results = '\n\nüîç Search Results:\n\n';
                    data.query.search.forEach(result => {
                        results += `**${result.title}**\n${result.snippet.replace(/<[^>]*>/g, '')}\n\n`;
                    });
                    return results;

                } else if (searchProvider === 'brave' && searchApiKey) {
                    const response = await fetch(`https://api.search.brave.com/res/v1/web/search?q=${encodeURIComponent(query)}`, {
                        headers: { 'X-Subscription-Token': searchApiKey }
                    });
                    const data = await response.json();
                    let results = '\n\nüîç Search Results:\n\n';
                    data.web?.results.slice(0, 5).forEach(r => {
                        results += `**${r.title}**\n${r.description}\n${r.url}\n\n`;
                    });
                    return results;
                }
            } catch (error) {
                console.error('Search error:', error);
                return '\n\nSearch unavailable.';
            }
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !currentModel || isGenerating) return;

            isGenerating = true;
            document.getElementById('sendBtn').disabled = true;
            closeSidebar();

            addMessage('user', message, attachedFiles);
            input.value = '';
            input.style.height = 'auto';

            const messages = chatHistory.map(msg => ({
                role: msg.role,
                content: msg.content,
                ...(msg.images && { images: msg.images })
            }));

            const assistantDiv = addMessage('assistant', '', []);
            const contentDiv = assistantDiv.querySelector('.message-content');
            contentDiv.innerHTML = '<div class="loading"><span></span><span></span><span></span></div>';

            try {
                if (webSearchEnabled) {
                    contentDiv.innerHTML = 'üîç Searching...';
                    const searchResults = await performWebSearch(message);
                    messages[messages.length - 1].content += searchResults;
                }

                const response = await fetch(`${ollamaHost}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: messages,
                        stream: true,
                        options: {
                            temperature: settings.temperature,
                            num_ctx: settings.contextLength
                        }
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                contentDiv.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        try {
                            const json = JSON.parse(line);
                            if (json.message?.content) {
                                fullResponse += json.message.content;
                                contentDiv.innerHTML = renderMarkdown(fullResponse);
                                highlightCode(contentDiv);
                            }
                        } catch (e) {}
                    }

                    document.getElementById('chatMessages').scrollTop = 999999;
                }

                chatHistory.push({ role: 'assistant', content: fullResponse });
                saveCurrentChat();

            } catch (error) {
                contentDiv.innerHTML = `<p style="color: #EF4444;">Error: ${error.message}</p>`;
            }

            attachedFiles = [];
            displayAttachedFiles();
            isGenerating = false;
            document.getElementById('sendBtn').disabled = false;
        }

        function addMessage(role, content, files = []) {
            const messagesDiv = document.getElementById('chatMessages');
            const welcome = messagesDiv.querySelector('.welcome-screen');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (role === 'user') {
                contentDiv.innerHTML = renderMarkdown(content);

                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = file.data;
                        img.className = 'file-preview-img';
                        contentDiv.appendChild(img);
                    }
                });

                const images = files.filter(f => f.type.startsWith('image/')).map(f => f.data.split(',')[1]);
                chatHistory.push({
                    role: 'user',
                    content: content,
                    ...(images.length > 0 && { images: images })
                });
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageDiv;
        }

        function renderMarkdown(text) {
            marked.setOptions({
                highlight: (code, lang) => {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });

            let html = marked.parse(text);
            html = html.replace(/<pre><code class="language-(\w+)">(.*?)<\/code><\/pre>/gs, (match, lang, code) => {
                const isHtml = lang.toLowerCase() === 'html';
                return `
                    <div class="code-header">
                        <span class="code-lang">${lang}</span>
                        <div class="code-actions">
                            <button class="code-btn" onclick="copyCode(this)">Copy</button>
                            ${isHtml ? '<button class="code-btn" onclick="previewHtml(this)">Preview</button>' : ''}
                        </div>
                    </div>
                    <pre><code class="language-${lang}">${code}</code></pre>
                `;
            });
            return html;
        }

        function highlightCode(container) {
            container.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        }

        function copyCode(btn) {
            const code = btn.closest('.code-header').nextElementSibling.querySelector('code').textContent;
            navigator.clipboard.writeText(code);
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = 'Copy', 2000);
        }

        function previewHtml(btn) {
            const codeElement = btn.closest('.code-header').nextElementSibling.querySelector('code');
            const html = codeElement.textContent;
            const existing = btn.closest('.message-content').querySelector('.preview-container');

            if (existing) {
                existing.remove();
                btn.textContent = 'Preview';
                return;
            }

            const preview = document.createElement('div');
            preview.className = 'preview-container';

            // Create an iframe for safe HTML rendering
            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.minHeight = '300px';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '6px';
            iframe.style.backgroundColor = '#fff';

            preview.appendChild(iframe);
            btn.closest('.code-header').nextElementSibling.after(preview);

            // Write HTML into iframe
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(html);
            iframeDoc.close();

            // Auto-resize iframe based on content
            setTimeout(() => {
                try {
                    const body = iframe.contentDocument.body;
                    const html = iframe.contentDocument.documentElement;
                    const height = Math.max(
                        body.scrollHeight,
                        body.offsetHeight,
                        html.clientHeight,
                        html.scrollHeight,
                        html.offsetHeight
                    );
                    iframe.style.height = (height + 20) + 'px';
                } catch (e) {
                    iframe.style.height = '400px';
                }
            }, 100);

            btn.textContent = 'Hide';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function loadSettings() {
            document.getElementById('ollamaHost').value = ollamaHost;
            document.getElementById('searchProvider').value = searchProvider;
            document.getElementById('searchApiKey').value = searchApiKey;
            document.getElementById('temperature').value = settings.temperature;
            document.getElementById('contextLength').value = settings.contextLength;
            document.getElementById('apiKeyGroup').classList.toggle('hidden', searchProvider !== 'brave');
        }

        function saveSettings() {
            ollamaHost = document.getElementById('ollamaHost').value;
            searchProvider = document.getElementById('searchProvider').value;
            searchApiKey = document.getElementById('searchApiKey').value;
            settings.temperature = parseFloat(document.getElementById('temperature').value);
            settings.contextLength = parseInt(document.getElementById('contextLength').value);

            localStorage.setItem('ollamaHost', ollamaHost);
            localStorage.setItem('searchProvider', searchProvider);
            localStorage.setItem('searchApiKey', searchApiKey);
            localStorage.setItem('temperature', settings.temperature);
            localStorage.setItem('contextLength', settings.contextLength);

            closeSettings();
            checkOllamaStatus();
            loadModels();
        }

        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') closeSettings();
        });
    </script>
</body>
</html>